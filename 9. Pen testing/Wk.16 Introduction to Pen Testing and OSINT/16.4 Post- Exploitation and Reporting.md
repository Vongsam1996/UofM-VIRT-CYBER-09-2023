Recap 16.3 
**Command and control (C2):** Framework that consists of tools and tech that attackers use to maintain communication with compromised devices follow initial exploitation 
- C2 architecture consist of; 
	- **C2 server**: Attacker's server, where the attacker communicate with the compromised machine 
	- **C2 agents:** The payload that is run on the compromised machine in order to open up a connection back to the C2 server

**Metasploit:** C2 framework that contains a suite of tools for enumerating the exploiting servers and other networked device 
- Main tools of Metasploit;
	- **MSFconsole**: Main interface for Metasploit, which runs on your local machine
	- **Metapreter:** A Linux-style shell that runs on the machine your compromise

**Post Exploitation** three common task;
 - *Enumeration and searching for useful data*: 
	 - Enumerating and searching for data from inside the target after it has been exploited 
- *Persistence*
	- Method of attempting to maintain long-term access into your target
- *Privilege Escalation*
	- Method of escalating privileges from a less-privileged user to a more-privileged user (or a low-privileged to high- privileged)
	- We use SSH from the last class
		- We search for Adminpassword.txt and found the password
		- Then we SSH into msfadmin@[ip address]
___
**Re-performing Enumeration after Privilege Escalation**
- **Low-Privileged**: Means having limited access to the machines 
	- In Linux, this typically means not being able to browse through configuration files or other home folders
	- You can move from low-privlege to high privilege
- **High-Privileged:** Means having high amount of access
	- In the case of root privileges are unrestricted 
	- Administrator 

Note: We can now re-perform enumeration as a high-privilege user to see if there are any other files that may be useful 

**High-Privilege Escalation**
![[16.4.0.jpg]]
- If you low-privilege user and you can look at these files within this 
- /var... 
	- Looking at user.MYD
- /home/ 
	- Looking at history from CMD/ terminal can show anyone who signed into password
	- .bash_history is a hidden file 
	- Mitigation: 
		- Set permission to admin
		- Delete history: Tell bash to not keep history 
- .ssh
	- They are like passwords 
	- You can use them to sign in into other users 
	- Example: Like Jump-box -> Using private key and sign into Azura environment 
		- IF they have the key, they can sign into any computer 
			- Unless you have rules 
		- 

*Can you think of any other file in Linux that holds extremely sensitive information and would be fruitful for an attack?*
- Logs 
- /etc/shadow

The /etc/shadow files is one of the most sensitive files on Linux, because it houses the password hashes for all user on the machine 
- Files is typically limited to root-level access
- Changed permissions (to see who has permission who is suppose to not have it)


![[16.4.1.jpg]]
- /etc/shadow file appears nearly identical to /etc/passwd there is stark difference 
- Mitigation 
	- Use a better hashing algorithm
	- Longer and complex password 

Instead of an x, like in the passwd file, the 2nd field in the shadow file (After the colon) contains a long, complex string;
![[16.4.2.jpg]]
- String is a password hash
- Hash can not be used to log in, but can be cracked to retrieve the user's original password 
- If a row in /etc/shadow contains an ! instead of a password hash, it means the account is locked
- If a row in /etc/shadow contains an * instead of a password hash, it means the user is nto allowed to log in 

___
Instructor Demo: John the ripper Refresher 
NOTE: We want to steal other people's passwords 

ssh msfadmin@172.22.117.150 
- From previous class
password:cybersecurity
ls -l
- This shows your permission (ALL)ALL
cat /etc/shadow
- This shows users 

What users you want to target? 
- Group users under 1000
	- They are systems 
- ![[16.4.0.1.jpg]]
	- We want to target anyone that has /bin/bash and /bin/sh

ls /home 
- Anyone who can sign into the computer 
	- We wamt tp target user and tstark
		- They can sign into the computer

sudo cat /etc/shadow
- ![[16.4.0.2.jpg]]
	- We want to copy between the user:$ and : 
- ![[16.4.0.3.jpg]]
	- This is what you want to copy 

These are the other user we want in nano - Named hash.txt
![[16.4.0.4.jpg]]

We want to john ripper hash.txt file 
![[16.4.0.5.jpg]]
- This is what we found 

___
**Persistence**
![[16.4.3.jpg]]

**Persistence:** refers to adversary maintaining their access to the target and to maintain; 
1. ***Technique 1: Utilizing Existing Service*** 
	- Persistence is less about exploitation of vulnerable software and services and more about utilizing existing system service
		- IE: 
			- Utilizing *useradd* to create a new user a Backdoor 
2. ***Technique 2: Blending into the Environment*** 
	- Persistence is making sure the attacker's work blends in with the current environment and can't be detected 
	- Knowledge of the system you're on is crucial for this 
		- IE: 
			- Creating a backdoor account, you want to blend in with current account names, instead of naming the account backdoor 
			- IE: Use sysadmin to pose as a system admin or systemd - ssh to pose as a service
3.  ***Technique 3: Maintaining Current Level of Access***
	- Key aspect of persistence is maintaining your current level of access
		- Typically should establish persistence as a low-privilege user before privilege escalation, just in case you lose access to the machine 
		- You should then re-establish persistence as an elevated user
		- Important to establish persistence and ensure persistence with the highest privilege possible, to avoid having to re-step through the privilege-escalation phase 
4. **Technique 4: Privesc Persistence***
	- **Privesc Persistence:** purposely establishing opportunities for low-privilege users to escalate their privileges 
	- IE 
		- ![[16.4.4.jpg]]
			- Linux or MacOS: setuid or setgid nits are set for an application, it will run with the privilege of the owning user or group 
				- Normally, application runs current's user's context, regardless of which user or group own the application
					- But, sometimes programs need to be run in an elevated context to function properly but the user running them doesn't need the elevated privileges
				- Attacker with root privileges, establish a privesc persistence script by creating a reverse shell in a python script and setting the SUID bit to root 

![[16.4.5.jpg]]

___
Activity: Persistence
NOTE: We are allowing port 10022 so we can sign into the server again 
- This is not a good way to backdoor because there is a lot of programs that reads these activity 

sudo less /etc/shh/shhd_config
![[16.4.0.6.jpg]]
- listenaddress
	- Listen to all ip address

sudo nano /etc/shh/sshd_config
![[16.4.0.7.jpg]]
- Adding Port 10022 
	- We open port 10022 because we do not want them to log our log in
- If we log into port 22 
	- There will be logs and they will see this and fix it 
Note: 
- If Linux - It is easier to hack into Linux machines because they might be harder to manage without any porgram
- if windows - It is easier to find because when you are login to the computer, it will show other user login


NOTE: We are going add a backdoor user as systemd-shh 
- This can be found if the ID is above 1000 which means they are not part of administrator 

sudo adduser systemd-ssh
password:password

ls /home 
- we can see our user in systemd-ssh 
	- Pen tester do not like this because it has crumbles 
	- So we want to hide it 

sudo reboot now

ssh -p 1002 systemd-ssh@172.22.117.150
password:password
![[16.4.0.8.jpg]]
- We are able to sign into the new user that we created named systemd-shh in open port 10022 that was created 

Mitigation: 
- Do not add random ports 
- Monitor for any users adding ports, users, and any users in admin group 


![[16.4.0.9.jpg]]
sudo usermod -aG admin systemd-ssh
- We are able to add systemd-ssh into admin group

Mitigation:
- Monitor logs with new admin group or id changes 
___
**Phase 5: Reporting**
**Reporting**
Communicating is the key component in linking actions to result 
- To the client, the quality of the report reflects the quality of the pen tester's work 
- Poorly written report could make the client believe the pentester is incompetent and the pentest was a failure, even if the pentester had several important finding 
- Well-written report will help establish the pentester's reputation and perhaps even generate repeat business, while taking a positive step toward remediating any finding within the client's network 

![[16.4.6.jpg]]
____
Instructor Demo: Report Walkthrough

___
Activity: Reporting

___
**kahoot**
![[16.4.7.jpg]]
![[16.4.8.jpg]]

