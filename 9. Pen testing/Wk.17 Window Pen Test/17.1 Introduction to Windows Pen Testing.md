**Windows Penetration Testing**
![[17.1.0.jpg]]
**Technique** is how a specific tactic is carried out 
___
**Linux, windows, ports, and protocol**
![[17.1.1.jpg]]
- An overwhelming majority of eterpricses use Windows Active Directory (AD) for directory services
	- Includes the administration of users, computers, and policies 

![[17.1.2.jpg]]
AD needs several ports open to properly communicate between the Domain control (DC) and workstations on the network
- change is made to a group policy in AD, work stations on the network that are connected to AD reach out to the DC over *port 445 and 135* to retrieve the group policy update 
- Kerberos, primary form of authentication in AD uses *port 88*

___
Activity: Port Scanning 

$nmap -sV -sC 172.22.117.0/24 -oA nmap -vv
- -sV: scan for verison 
- sC: Scan for certification 
- 172.22.117.0/24: Want to scan all the subnets which that port 
- rest: To save the results in a file 

Scan the subnet for live host, open ports, and vulnerability 
![[100.jpg]]
port 80 is open 
- It is telling you 
	- It is a website and what do you want to see what type of website 
	- We want to see if the website is horribly designed 

VNC is open as well 
Note: This is us which means it is usuless 

![[10.jpg]]
- kerberos is a domain controller 
	- A domain controller is a computer that can manage all other computers 
port 88 and 636 works together 

![[20.jpg]]
port 135, 139, 445, 3390 are open
- 135 and 139 are usually together 
- This tells you that there is nothing but they have a remote windows 

How many windows machine are on the network?
Two machines 
- 10 and 20 

We rescan the nmap and found another machine we can attack 

___
**Windows Authentication and Password-based Attacks**
**Windows Authentication**
Two primary type of authentication in windows;
1. Kerberos: Default protocol for authentication in windows and is heavily used in Active Directory 
2. NTLM: Kerberos authentication is not possible, then windows falls back to NTLM

**Kerberos vs NTLM**
Windows New Technology LAN Manager (NTML): a challenge-response protocol and used a three-step method; 
1. Negotiation message from the client
2. Challenge message from the server
3. Authentication message from the client 

![[17.1.3.jpg]]

![[17.1.4.jpg]]
NTLM was replaced by kerberos in windows 2000 and beyond due to several insecurities 
- NTLM password hashes were not salted (Random string of character was not added to hashed password to further protect it from cracking techniques)
	- NTLM password could be easily be brute-forced 

It creates the password 
- it adds random text and then hash it so it can not be reversed hashed 

Kerberos differs from NTLM by using a **Ticketing system** instead of a three-step method 
![[17.1.5.jpg]]

![[17.1.0.0.jpg]]

NTLM and Kerberos 
1. Kerberos: Kerberos authentication is used for domain accounts
	1. companies uses this 
	2. It is harder to forge tickets and passwords 
2. NTLM: Authentication is used for local account 
	1. We are using this hard
Notes: This is because normal windows workstations and non-DC server are not KDCs and thus cannot process kerberos tickets 


___
**Password-based Attacks**
**Security Account Manager(SAM)**: Where local password are stored 
- Local user tried to authenticate to their own computer 
- Computer issue and verifies the challenge to check the password, instead of a different machine 
	- This will allow an attacker to **brute-force** or attempt to log in to an account by tryiing multiple password 

*What potential problem could a pen tester run into when attempting to brute-force password*
- They can close ports 
- Dos 
	- Crashing the servers 
	- Locking accounts 
*what can hackers attack*
- How to prevent brute force lock out 
	- We can use burpsuite
		- For scan 
	- John


**Risk of Brute Force Attacks**
Local account, by default, do not disable an account from logging in due to a bad password
- Events are generated by windows for each failed login attempt even for local account 
- If a blue team member is monitoring these login, it's very apparent when an attack is occurring 
- We will investigate this type of attack from a blue team perspective later in the course 

**Password Spraying**
![[17.1.6.jpg]]
Successfully brute-forcing a domain account in Windows is due to default group policy that locks an account after five bad password attempt
- Instead of domain account (Which use Kerberos), **Password spraying** is a more common attack

**Password Spraying:**  Involves getting a list of usernames and attempting a single password for those account 
- type of brute force 

*Can you think of any common passwords that might be useful in a password spray attack?*

**Common Passwords**
- SeasonYear (EI: Spring 2021)
- Any variation of the word password
- PresidentYear
- LetMeIn
- ILoveYou

![[17.1.0.1.jpg]]

___
Activity: password Spraying
Note: We are doing this because we already found their /etc/shadow/ already 

We are going to go into metasploit 
$msfconsole 

Now we are going to use the auxiltery scanner 
$use auxiliary/scanner/smb/smb_login
- We are scanning (for username and password to see if it successful)

Since we have tstark already from brute force activity 
$options
- We want to  see what we need to input 

set RHOST 172.22.117.0/24
- We are going to scan all network from tstark 
set SMBUser tstark
set SMBPASS Password!

Domain: megacorpone.local
set smbdomain megacorpone 

run 

NOTE WE NEED TO REDUE THIS 
We got 2 hits 
![[Brute force 1.jpg]]

![[smbattack.jpg]]
Mitigation: 
- Network Monitoring 
- password complex

go to WINDC01 Machine
try signing as 
tstark
Password!

Sign in locally
./tstark
password!

does not work so ./tstark does not work

try to sign into 
WINDC01 machine 

![[Unable to signin.jpg]]
Even though we were able to sign in through the SMB, we can not sign into the remotely 


___


**LLMNR Poisoning**
**Local Link Multicast Name Resolution (LLMNR)** : An older broadcast protocol that serves as a local backup for DNS 
- LLMNR is a broadcast protocol, request is sent out to the entire network rather than to a single host 
- LLMNR is an older protocol that is left on in the default group policy 
- Attackers can listen for LLMNR request broadcast on the network and spoofing (faking) a response to the request asking for the requesting computer to complete a password challenge 

![[17.1.7.jpg]]![[17.1.8.jpg]]
- Braodcast is important 
	- It is listening to anyone who is looking for answers, mistakes and etc 

![[17.1.9.jpg]]

![[17.1.10.jpg]]

**LLMNR:** Broadcast protocol meaning an LLMNR request is sent out to the entire network instead of going to a single host
- Pen testers are looking for people who are trying to access a file share
	- Anyone who tries to access it, then it will ask for username and passwords 

NOTE: Migtation
- Salt 
- Encryption 
____
Activity: LLMNR Spoofing 

Responder 
sudo responder -I eth1 -v 
- repsonder respond to broadcast traffic 
	- Listening for events 
		- Listening for 
		- ![[17.1.0.2.jpg]]
![[hashword 2.jpg]]
- This is a password hash 
We want to copy and paste the hash in a nano called responder From pparker -> 0 (everything after :)

![[JohnLLMNR spoofing.jpg]]
- Created nano called responder.txt, inside the txt file, we inputed the hash from above 
- John the responder.txt and we can see the password;
	- pparker:Spring2021

Research honeynets 

___
**Windows Exploitation and WMI**
**Window Exploitation**
- Compromise a windows machine, we will exploit any vulnerable services on the system and leverage legitimate tools and services for windows 

**WMI**
**Windows Management Instrumentation (WMI)**: Microsoft tool created with the intention of remotely administering window machine 
- Similar to how most Linux machines are managed over SSH, windows machines can be managed remotely via WMI 
- WMI operates over RPC, which is port 135
	- WMI operate pm port 135, also used for communication for AD, a port scan against the Windows machine does not show the service WMI on port 135, as WMI simply leverages the RPC protocol on the port for communications 
- WMI is a default installed tool on Windows 

____
Instructor Demo: WMI

msfconsole 
use auxiliary/scanner/smb/impacket/wmiexec
options
- command
	- set COMMAND whoami
- set smbdomain 
	- Megacorpone
- Rhosts
	- set RHOSTS 172.22.117.20
- smbuser
	- set smbuser tstark
- smbpass
	- Password!
![[whoami.jpg]]

![[Tasklist.jpg]]

![[Systeminfo.jpg]]
What version and build number of windows 
set command setinfo
Version 10.0.19042 build 
	- We can search for exploits for this windows

What processor architecture is the machine
set command setinfo
- x64
![[net session.jpg]]
Are there any users logged in?
set command net session 
- No
- Looks like only tstark

![[net share.jpg]]
What shares are available on the machine 
set command net share
- C (Default Share)
- IPC (Remote IPC)
- ADMIN$ (Remote Admin)

___

*What port does WMI use?*
135 (RPC)